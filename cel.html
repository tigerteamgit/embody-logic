<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Creative Expansion Lab</title>
  <style>
    /* ---- Base ---- */
    :root{
      --bg:#0b0b0b;
      --paper:#ffffff;
      --ink:#111;
      --muted:#666;
      --line:#eaeaea;
      --accent:#111;
      --soft:#f6f6f6;
      --good:#0b7;
      --warn:#c80;
      --bad:#d33;
      --radius:14px;
      --shadow:0 12px 30px rgba(0,0,0,.12);
      --max: 860px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #101010, #0b0b0b);
      color:#eee;
    }
    header{
      position: sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(10,10,10,.75);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .bar{
      max-width: var(--max);
      margin: 0 auto;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
    }
    .title strong{ font-size: 15px; letter-spacing:.2px; }
    .title span{ font-size: 12px; color: rgba(255,255,255,.65); }
    .pill{
      font-size:12px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.16);
      border-radius: 999px;
      color: rgba(255,255,255,.8);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }
    main{
      max-width: var(--max);
      margin: 18px auto 80px;
      padding: 0 16px;
    }
    .card{
      background: var(--paper);
      color: var(--ink);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      margin: 14px 0;
      border: 1px solid rgba(0,0,0,.06);
    }
    .card h1, .card h2, .card h3 { margin: 0 0 10px; }
    .muted{ color: var(--muted); }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .row > *{ flex: 1; }
    label{ font-size:13px; color:#333; display:block; margin:10px 0 6px; }
    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      color:#111;
      outline:none;
    }
    textarea{ min-height: 120px; resize: vertical; }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    button{
      border:0;
      border-radius: 12px;
      padding: 12px 14px;
      font-weight: 650;
      cursor:pointer;
    }
    .btn-primary{ background: #111; color:#fff; }
    .btn-soft{ background: var(--soft); color:#111; }
    .btn-danger{ background: #d33; color:#fff; }
    .btn-outline{
      background: transparent;
      border:1px solid rgba(255,255,255,.22);
      color:#fff;
    }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .hr{ height:1px; background: var(--line); margin: 14px 0; }
    .kpi{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:10px;
    }
    .kpi .box{
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: #fff;
    }
    .kpi .box .n{ font-size: 24px; font-weight: 800; }
    .kpi .box .t{ font-size: 12px; color: var(--muted); }
    .notice{
      background: #fff7e6;
      border: 1px solid #ffe0a8;
      padding: 12px 14px;
      border-radius: 12px;
      color:#5a3d00;
    }
    .good{ color: var(--good); font-weight:700; }
    .warn{ color: var(--warn); font-weight:700; }
    .bad{ color: var(--bad); font-weight:700; }
    .timer{
      font-variant-numeric: tabular-nums;
      font-size: 13px;
      color: rgba(255,255,255,.9);
    }
    .progress{
      height:8px;
      background: rgba(255,255,255,.12);
      border-radius:999px;
      overflow:hidden;
    }
    .progress > div{
      height:100%;
      width:0%;
      background: rgba(255,255,255,.9);
      transition: width .2s ease;
    }

    /* ---- Responsive KPI ---- */
    @media (max-width: 900px){
      .kpi{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">
      <strong>Creative Expansion Lab</strong>
      <span>Playful experiment. Serious metrics. Private by default (stored in your browser).</span>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <div class="pill timer" id="timerPill">Timer: 00:00</div>
      <button class="btn-outline" id="exportBtn" type="button">Export CSV</button>
      <button class="btn-outline" id="resetAllBtn" type="button">Reset</button>
    </div>
  </div>
  <div class="bar" style="padding-top:0;">
    <div style="width:100%">
      <div class="progress"><div id="progressBar"></div></div>
      <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:12px; color:rgba(255,255,255,.7)">
        <span id="stepLabel">Step</span>
        <span id="modeLabel">Mode: Baseline</span>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="card" id="introCard">
    <h1>Baseline + Post Course Assessment</h1>
    <p class="muted">
      This is a timed creativity + cognition experiment + a simple somatic expansion check. You’ll take it twice:
      once at the start (Baseline) and once at the end (Post). Your results stay on your device and can be exported as CSV.
    </p>

    <div class="notice">
      <strong>How to win:</strong> don’t filter. Don’t polish. Generate, connect, and shift perspectives quickly.
    </div>

    <div class="row">
      <div>
        <label>Attempt type</label>
        <select id="attemptType">
          <option value="baseline">Baseline</option>
          <option value="post">Post</option>
        </select>
      </div>
      <div>
        <label>Display name (optional)</label>
        <input id="displayName" type="text" placeholder="e.g., Jesse" />
      </div>
    </div>

    <div class="btns">
      <button class="btn-primary" id="startBtn" type="button">Start Lab</button>
      <button class="btn-soft" id="viewResultsBtn" type="button">View Stored Results</button>
    </div>
  </div>

  <div class="card" id="labCard" style="display:none;">
    <h2 id="roundTitle">Round</h2>
    <p class="muted" id="roundDesc"></p>
    <div class="hr"></div>

    <div id="roundBody"></div>

    <div class="btns">
      <button class="btn-soft" id="backBtn" type="button">Back</button>
      <button class="btn-primary" id="nextBtn" type="button">Next</button>
    </div>
  </div>

  <div class="card" id="resultsCard" style="display:none;">
    <h2>Results</h2>
    <p class="muted">Scores are stored locally (on this device). Export CSV if you want your database portable.</p>

    <div class="kpi" style="margin-top:12px;">
      <div class="box"><div class="n" id="ceiN">—</div><div class="t">Creative Expansion Index (0–100)</div></div>
      <div class="box"><div class="n" id="fluencyN">—</div><div class="t">Fluency</div></div>
      <div class="box"><div class="n" id="flexN">—</div><div class="t">Flexibility</div></div>
      <div class="box"><div class="n" id="assocN">—</div><div class="t">Associative Strength</div></div>
      <div class="box"><div class="n" id="shiftN">—</div><div class="t">Perspective Shift</div></div>
    </div>

    <div class="kpi" style="margin-top:10px;">
      <div class="box"><div class="n" id="ambN">—</div><div class="t">Ambiguity Tolerance</div></div>
      <div class="box"><div class="n" id="complexN">—</div><div class="t">Complexity Handling</div></div>
      <div class="box"><div class="n" id="totalIdeasN">—</div><div class="t">Ideas Count (Round 1)</div></div>
      <div class="box"><div class="n" id="catsN">—</div><div class="t">Categories (Round 1)</div></div>
      <div class="box"><div class="n" id="timeN">—</div><div class="t">Active Time</div></div>
    </div>

    <div class="kpi" style="margin-top:10px;">
      <div class="box"><div class="n" id="seiN">—</div><div class="t">Somatic Expansion Index (0–100)</div></div>
      <div class="box"><div class="n" id="eesN">—</div><div class="t">Embodied Expansion Score</div></div>
      <div class="box"><div class="n" id="gapN">—</div><div class="t">Integration Gap (lower is better)</div></div>
      <div class="box"><div class="n" id="rangeN">—</div><div class="t">Range (0–20)</div></div>
      <div class="box"><div class="n" id="recoveryN">—</div><div class="t">Recovery (0–20)</div></div>
    </div>

    <div class="hr"></div>

    <div id="comparisonBlock"></div>

    <div class="btns">
      <button class="btn-soft" id="retakeBtn" type="button">New Attempt</button>
      <button class="btn-primary" id="backHomeBtn" type="button">Back Home</button>
    </div>
  </div>
</main>

<script>
/* ---- Storage ---- */
const STORAGE_KEY = "cel_attempts_v1";

/* ---- Round definitions ---- */
const ROUNDS = [
  {
    id: "divergence",
    title: "Round 1 — Divergence Sprint (Raw Range)",
    desc: "5 minutes. List uses / meanings / metaphors. Speed > polish.",
    timedSeconds: 5 * 60,
    render: (state) => {
      return `
        <div class="notice"><strong>Rules:</strong> One idea per line. Don’t censor. Keep moving.</div>

        <label>Water — uses / meanings (one per line)</label>
        <textarea id="r1_water" placeholder="e.g., currency, memory, cooling system, ritual...">${escapeHtml(state.r1_water || "")}</textarea>

        <label>Rock — uses / meanings (one per line)</label>
        <textarea id="r1_rock" placeholder="e.g., foundation, percussion, obstacle, signal...">${escapeHtml(state.r1_rock || "")}</textarea>

        <label>Light — uses / meanings (one per line)</label>
        <textarea id="r1_light" placeholder="e.g., navigation, truth, growth cue, encryption...">${escapeHtml(state.r1_light || "")}</textarea>

        <div class="row">
          <div>
            <label>Category count (0–10+) (how many distinct buckets you hit)</label>
            <input id="r1_categories" type="number" min="0" max="20" value="${state.r1_categories ?? ""}" placeholder="e.g., 8" />
            <div class="muted" style="font-size:12px;margin-top:6px;">
              Examples: physical, emotional, scientific, cultural, symbolic, functional, narrative, systemic, philosophical…
            </div>
          </div>
          <div>
            <label>Most unusual idea (copy/paste one line)</label>
            <input id="r1_unusual" type="text" value="${escapeHtml(state.r1_unusual || "")}" placeholder="e.g., Light as 'error-correcting code'"/>
          </div>
        </div>
      `;
    },
    collect: (state) => {
      state.r1_water = val("r1_water");
      state.r1_rock = val("r1_rock");
      state.r1_light = val("r1_light");
      state.r1_categories = num("r1_categories");
      state.r1_unusual = val("r1_unusual");
    }
  },
  {
    id: "forced_connection",
    title: "Round 2 — Forced Connection Engine",
    desc: "Connect three words into one idea. Then score it with the rubric.",
    timedSeconds: 5 * 60,
    render: (state) => {
      return `
        <div class="notice"><strong>Your words:</strong> Ocean • Clock • Thread</div>
        <label>Write a paragraph connecting all three</label>
        <textarea id="r2_text" placeholder="Write 6–10 lines...">${escapeHtml(state.r2_text || "")}</textarea>

        <div class="row">
          <div>
            <label>Coherence (1–5)</label>
            <input id="r2_coherence" type="number" min="1" max="5" value="${state.r2_coherence ?? ""}" />
          </div>
          <div>
            <label>Originality (1–5)</label>
            <input id="r2_originality" type="number" min="1" max="5" value="${state.r2_originality ?? ""}" />
          </div>
          <div>
            <label>Depth (1–5)</label>
            <input id="r2_depth" type="number" min="1" max="5" value="${state.r2_depth ?? ""}" />
          </div>
        </div>

        <div class="muted" style="font-size:12px;">
          Rubric: Coherence = it makes sense; Originality = not cliché; Depth = layers, implications, metaphor, mechanism.
        </div>
      `;
    },
    collect: (state) => {
      state.r2_text = val("r2_text");
      state.r2_coherence = num("r2_coherence");
      state.r2_originality = num("r2_originality");
      state.r2_depth = num("r2_depth");
    }
  },
  {
    id: "perspective_shift",
    title: "Round 3 — Perspective Shift Drill",
    desc: "Argue both sides. 3 FOR and 3 AGAINST. Then score your balance + nuance.",
    timedSeconds: 5 * 60,
    render: (state) => {
      return `
        <div class="notice"><strong>Claim:</strong> “Constraints increase creativity.”</div>

        <label>FOR — 3 arguments (one per line)</label>
        <textarea id="r3_for" placeholder="1) ...&#10;2) ...&#10;3) ...">${escapeHtml(state.r3_for || "")}</textarea>

        <label>AGAINST — 3 arguments (one per line)</label>
        <textarea id="r3_against" placeholder="1) ...&#10;2) ...&#10;3) ...">${escapeHtml(state.r3_against || "")}</textarea>

        <div class="row">
          <div>
            <label>Symmetry (1–5) (both sides equally strong?)</label>
            <input id="r3_symmetry" type="number" min="1" max="5" value="${state.r3_symmetry ?? ""}" />
          </div>
          <div>
            <label>Nuance (1–5) (non-obvious, multi-layer?)</label>
            <input id="r3_nuance" type="number" min="1" max="5" value="${state.r3_nuance ?? ""}" />
          </div>
          <div>
            <label>Non-redundancy (1–5) (unique points?)</label>
            <input id="r3_unique" type="number" min="1" max="5" value="${state.r3_unique ?? ""}" />
          </div>
        </div>
      `;
    },
    collect: (state) => {
      state.r3_for = val("r3_for");
      state.r3_against = val("r3_against");
      state.r3_symmetry = num("r3_symmetry");
      state.r3_nuance = num("r3_nuance");
      state.r3_unique = num("r3_unique");
    }
  },
  {
    id: "ambiguity",
    title: "Round 4 — Ambiguity Field",
    desc: "Answer a vague prompt. Then rate your comfort and your urge to resolve.",
    timedSeconds: 4 * 60,
    render: (state) => {
      return `
        <div class="notice"><strong>Prompt:</strong> Gravity is half as strong tomorrow. What changes, and what new industries appear?</div>
        <label>Your response</label>
        <textarea id="r4_text" placeholder="Write freely...">${escapeHtml(state.r4_text || "")}</textarea>

        <div class="row">
          <div>
            <label>Comfort in uncertainty (1–10)</label>
            <input id="r4_comfort" type="number" min="1" max="10" value="${state.r4_comfort ?? ""}" />
          </div>
          <div>
            <label>Urge to resolve quickly (1–10) (higher = more urgency)</label>
            <input id="r4_urge" type="number" min="1" max="10" value="${state.r4_urge ?? ""}" />
          </div>
        </div>

        <div class="muted" style="font-size:12px;">
          Tip: ambiguity tolerance isn’t passivity — it’s capacity to stay open without collapsing into a single answer.
        </div>
      `;
    },
    collect: (state) => {
      state.r4_text = val("r4_text");
      state.r4_comfort = num("r4_comfort");
      state.r4_urge = num("r4_urge");
    }
  },
  {
    id: "complexity",
    title: "Round 5 — Complexity Handling",
    desc: "Design a system. Score how many variables and feedback loops you included.",
    timedSeconds: 6 * 60,
    render: (state) => {
      return `
        <div class="notice"><strong>Challenge:</strong> Design a system that helps a city reduce traffic without building new roads.</div>
        <label>Your system sketch (text)</label>
        <textarea id="r5_text" placeholder="Include constraints, incentives, feedback loops, unintended consequences...">${escapeHtml(state.r5_text || "")}</textarea>

        <div class="row">
          <div>
            <label>Variables considered (0–20)</label>
            <input id="r5_vars" type="number" min="0" max="50" value="${state.r5_vars ?? ""}" placeholder="e.g., 9" />
            <div class="muted" style="font-size:12px;margin-top:6px;">
              Examples: pricing, transit frequency, employer incentives, zoning, school schedules, freight windows, remote work, enforcement…
            </div>
          </div>
          <div>
            <label>Feedback loops / second-order effects (0–10)</label>
            <input id="r5_loops" type="number" min="0" max="20" value="${state.r5_loops ?? ""}" placeholder="e.g., 3" />
            <div class="muted" style="font-size:12px;margin-top:6px;">Count explicit loops: “If X increases, Y decreases, which causes Z…”</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Clarity (1–5)</label>
            <input id="r5_clarity" type="number" min="1" max="5" value="${state.r5_clarity ?? ""}" />
          </div>
          <div>
            <label>Originality (1–5)</label>
            <input id="r5_originality" type="number" min="1" max="5" value="${state.r5_originality ?? ""}" />
          </div>
          <div>
            <label>Depth (1–5)</label>
            <input id="r5_depth" type="number" min="1" max="5" value="${state.r5_depth ?? ""}" />
          </div>
        </div>
      `;
    },
    collect: (state) => {
      state.r5_text = val("r5_text");
      state.r5_vars = num("r5_vars");
      state.r5_loops = num("r5_loops");
      state.r5_clarity = num("r5_clarity");
      state.r5_originality = num("r5_originality");
      state.r5_depth = num("r5_depth");
    }
  },
  {
    id: "somatic",
    title: "Round 6 — Somatic Expansion Lab",
    desc: "No equipment. Self-timed. Enter results. Same protocol for Baseline + Post.",
    timedSeconds: 0,
    render: (state) => {
      return `
        <div class="notice">
          <strong>Instructions:</strong> Do each test safely. Use a phone timer if needed. Enter honest results.
        </div>

        <h3 style="margin-top:10px;">Test 1 — Forward Fold Reach (0–20)</h3>
        <label>Select your best match</label>
        <select id="s1_fold">
          <option value="">Select…</option>
          <option value="0"  ${state.s1_fold==0  ? "selected":""}>0 — Hands above knees</option>
          <option value="5"  ${state.s1_fold==5  ? "selected":""}>5 — Fingertips to shins</option>
          <option value="10" ${state.s1_fold==10 ? "selected":""}>10 — Fingertips to ankles</option>
          <option value="15" ${state.s1_fold==15 ? "selected":""}>15 — Touch toes</option>
          <option value="20" ${state.s1_fold==20 ? "selected":""}>20 — Palms flat on floor</option>
        </select>

        <div class="hr"></div>

        <h3>Test 2 — Cross-Body Coordination (30 sec)</h3>
        <p class="muted">Opposite elbow to knee, alternating, for 30 seconds. Count smooth reps.</p>
        <label>Reps in 30 seconds</label>
        <input id="s2_reps" type="number" min="0" max="200" value="${state.s2_reps ?? ""}" placeholder="e.g., 18" />

        <div class="hr"></div>

        <h3>Test 3 — Balance (Eyes closed)</h3>
        <p class="muted">Single leg, eyes closed. Time until you step/wobble out.</p>
        <label>Seconds held</label>
        <input id="s3_balance_sec" type="number" min="0" max="300" value="${state.s3_balance_sec ?? ""}" placeholder="e.g., 12" />

        <div class="hr"></div>

        <h3>Test 4 — Recovery (15 squats)</h3>
        <p class="muted">Do 15 bodyweight squats. Time until your breathing feels calm again.</p>
        <label>Seconds to calm breathing</label>
        <input id="s4_recovery_sec" type="number" min="0" max="600" value="${state.s4_recovery_sec ?? ""}" placeholder="e.g., 55" />

        <p class="muted" style="font-size:12px; margin-top:10px;">
          Tip: This isn’t wellness. It’s capacity. Track honestly and compare Baseline vs Post.
        </p>
      `;
    },
    collect: (state) => {
      const fold = document.getElementById("s1_fold")?.value;
      state.s1_fold = fold === "" ? null : Number(fold);

      state.s2_reps = num("s2_reps");
      state.s3_balance_sec = num("s3_balance_sec");
      state.s4_recovery_sec = num("s4_recovery_sec");
    }
  }
];

/* ---- App state ---- */
const state = {
  attemptType: "baseline",
  displayName: "",
  startedAt: null,
  finishedAt: null,
  activeSeconds: 0,
  roundIndex: 0,
  timer: { running:false, endAt: null, intervalId: null },
  // responses live on state object
};

/* ---- DOM ---- */
const introCard = document.getElementById("introCard");
const labCard = document.getElementById("labCard");
const resultsCard = document.getElementById("resultsCard");
const roundTitle = document.getElementById("roundTitle");
const roundDesc = document.getElementById("roundDesc");
const roundBody = document.getElementById("roundBody");
const timerPill = document.getElementById("timerPill");
const progressBar = document.getElementById("progressBar");
const stepLabel = document.getElementById("stepLabel");
const modeLabel = document.getElementById("modeLabel");

document.getElementById("startBtn").addEventListener("click", startLab);
document.getElementById("viewResultsBtn").addEventListener("click", showStoredResults);
document.getElementById("backBtn").addEventListener("click", prevRound);
document.getElementById("nextBtn").addEventListener("click", nextRound);
document.getElementById("retakeBtn").addEventListener("click", () => { resetAttempt(false); showIntro(); });
document.getElementById("backHomeBtn").addEventListener("click", showIntro);
document.getElementById("exportBtn").addEventListener("click", exportCSV);
document.getElementById("resetAllBtn").addEventListener("click", resetAll);

/* ---- Helpers ---- */
function val(id){ const el=document.getElementById(id); return el ? el.value.trim() : ""; }
function num(id){
  const el=document.getElementById(id);
  if(!el) return null;
  const v = el.value === "" ? null : Number(el.value);
  return Number.isFinite(v) ? v : null;
}
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function fmtTime(sec){
  const m = Math.floor(sec/60);
  const s = sec%60;
  return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}
function setProgress(){
  const totalSteps = ROUNDS.length + 1; // intro + rounds (visual only)
  const step = state.roundIndex + 1;
  progressBar.style.width = `${Math.round((step/totalSteps)*100)}%`;
  stepLabel.textContent = `Round ${state.roundIndex+1} of ${ROUNDS.length}`;
  modeLabel.textContent = `Mode: ${state.attemptType === "baseline" ? "Baseline" : "Post"}`;
}

/* ---- Timer ---- */
function startTimer(seconds){
  stopTimer();
  state.timer.running = true;
  const now = Date.now();
  state.timer.endAt = now + seconds*1000;

  state.timer.intervalId = setInterval(() => {
    const leftMs = state.timer.endAt - Date.now();
    const left = Math.max(0, Math.ceil(leftMs/1000));
    timerPill.textContent = `Timer: ${fmtTime(left)}`;

    if(left <= 0){
      stopTimer();
      // auto-advance when time ends
      nextRound();
    }
  }, 250);
}
function stopTimer(){
  if(state.timer.intervalId) clearInterval(state.timer.intervalId);
  state.timer.intervalId = null;
  state.timer.running = false;
}

/* ---- Navigation ---- */
function showIntro(){
  stopTimer();
  introCard.style.display = "block";
  labCard.style.display = "none";
  resultsCard.style.display = "none";
  timerPill.textContent = `Timer: 00:00`;
  progressBar.style.width = "0%";
  stepLabel.textContent = "Step";
  modeLabel.textContent = `Mode: ${state.attemptType === "baseline" ? "Baseline" : "Post"}`;
}
function showLab(){
  introCard.style.display = "none";
  labCard.style.display = "block";
  resultsCard.style.display = "none";
}
function showResults(attempt){
  introCard.style.display = "none";
  labCard.style.display = "none";
  resultsCard.style.display = "block";

  document.getElementById("ceiN").textContent = attempt.scores.cei ?? "—";
  document.getElementById("fluencyN").textContent = attempt.scores.fluency ?? "—";
  document.getElementById("flexN").textContent = attempt.scores.flexibility ?? "—";
  document.getElementById("assocN").textContent = attempt.scores.associative ?? "—";
  document.getElementById("shiftN").textContent = attempt.scores.perspective ?? "—";
  document.getElementById("ambN").textContent = attempt.scores.ambiguity ?? "—";
  document.getElementById("complexN").textContent = attempt.scores.complexity ?? "—";

  document.getElementById("totalIdeasN").textContent = attempt.scores.ideaCount ?? "—";
  document.getElementById("catsN").textContent = attempt.scores.categoryCount ?? "—";
  document.getElementById("timeN").textContent = fmtTime(attempt.meta.activeSeconds ?? 0);

  document.getElementById("seiN").textContent = attempt.scores.sei ?? "—";
  document.getElementById("eesN").textContent = attempt.scores.ees ?? "—";
  document.getElementById("gapN").textContent = attempt.scores.gap ?? "—";
  document.getElementById("rangeN").textContent = attempt.scores.somatic_range ?? "—";
  document.getElementById("recoveryN").textContent = attempt.scores.somatic_recovery ?? "—";

  renderComparison(attempt);
}

/* ---- Start / Reset ---- */
function startLab(){
  state.attemptType = document.getElementById("attemptType").value;
  state.displayName = document.getElementById("displayName").value.trim();
  state.startedAt = new Date().toISOString();
  state.finishedAt = null;
  state.activeSeconds = 0;
  state.roundIndex = 0;

  showLab();
  renderRound();
}
function resetAttempt(clearName){
  stopTimer();
  // wipe response keys for rounds + somatic
  for (const key of Object.keys(state)) {
    if (key.startsWith("r") || key.startsWith("s")) delete state[key];
  }
  state.startedAt = null;
  state.finishedAt = null;
  state.activeSeconds = 0;
  state.roundIndex = 0;
  if(clearName) state.displayName = "";
}
function resetAll(){
  if(!confirm("Reset all stored attempts on this device?")) return;
  localStorage.removeItem(STORAGE_KEY);
  alert("Local results cleared.");
}
function prevRound(){
  if(state.roundIndex <= 0) return;
  ROUNDS[state.roundIndex].collect(state);
  state.roundIndex -= 1;
  renderRound();
}
function nextRound(){
  // collect current if in bounds
  if(state.roundIndex >= 0 && state.roundIndex < ROUNDS.length){
    ROUNDS[state.roundIndex].collect(state);
  }

  // advance
  if(state.roundIndex < ROUNDS.length - 1){
    state.roundIndex += 1;
    renderRound();
  } else {
    finishAndScore();
  }
}

/* ---- Render ---- */
let roundInputHandler = null;
  
function renderRound(){
  stopTimer();
  setProgress();

  const round = ROUNDS[state.roundIndex];
  roundTitle.textContent = round.title;
  roundDesc.textContent = round.desc;
  roundBody.innerHTML = round.render(state);

  // timer: don't auto-advance for untimed rounds
  
   // Remove prior handler (important when moving between rounds)
  if (roundInputHandler) {
    roundBody.removeEventListener("input", roundInputHandler);
  }

  // Keep updating validation as the user types (NO { once:true })
  roundInputHandler = () => updateNextButtonState();
  roundBody.addEventListener("input", roundInputHandler);

  // Run once immediately so the button state matches existing values
  updateNextButtonState();

  // Timer: don't auto-advance for untimed rounds
  if (round.timedSeconds && round.timedSeconds > 0) {
    timerPill.textContent = `Timer: ${fmtTime(round.timedSeconds)}`;
    startTimer(round.timedSeconds);
  } else {
    timerPill.textContent = `Timer: —`;
    stopTimer();
  }
}

/* ---- Validation (accuracy) ---- */
function updateNextButtonState(){
  const round = ROUNDS[state.roundIndex];
  const nextBtn = document.getElementById("nextBtn");
  if(!nextBtn) return;

  // Default allow
  let ok = true;

  if(round.id === "forced_connection"){
    ok = [num("r2_coherence"), num("r2_originality"), num("r2_depth")]
      .every(v => v !== null && v >= 1 && v <= 5);
  } else if(round.id === "perspective_shift"){
    ok = [num("r3_symmetry"), num("r3_nuance"), num("r3_unique")]
      .every(v => v !== null && v >= 1 && v <= 5);
  } else if(round.id === "ambiguity"){
    ok = [num("r4_comfort"), num("r4_urge")]
      .every(v => v !== null && v >= 1 && v <= 10);
  } else if(round.id === "complexity"){
    ok = [num("r5_clarity"), num("r5_originality"), num("r5_depth")]
      .every(v => v !== null && v >= 1 && v <= 5);
  } else if(round.id === "somatic"){
    const fold = document.getElementById("s1_fold")?.value ?? "";
    ok = fold !== "" &&
      num("s2_reps") !== null &&
      num("s3_balance_sec") !== null &&
      num("s4_recovery_sec") !== null;
  }

  nextBtn.disabled = !ok;
}

/* ---- Scoring ---- */
function splitIdeas(text){
  return text
    .split(/\r?\n/)
    .map(s => s.trim())
    .filter(Boolean);
}
function scoreRound1Fluency(ideaCount){
  // tuned for higher-association prompts (water/rock/light)
  if(ideaCount <= 10) return 5;
  if(ideaCount <= 20) return 10;
  if(ideaCount <= 35) return 15;
  return 20;
}
function scoreRound1Flex(categories){
  const c = clamp(categories ?? 0, 0, 20);
  if(c <= 3) return 5;
  if(c <= 6) return 10;
  if(c <= 8) return 15;
  return 20;
}
function scoreRubric5(a,b,c){
  // each 1–5 -> sum 3..15 -> map to 0..20
  const A = clamp(a ?? 1, 1, 5);
  const B = clamp(b ?? 1, 1, 5);
  const C = clamp(c ?? 1, 1, 5);
  const sum = A+B+C; // 3..15
  const norm = (sum - 3) / 12; // 0..1
  return Math.round(norm * 20);
}
function scoreAmbiguity(comfort, urge){
  // comfort 1..10; urge 1..10 reversed
  const c = clamp(comfort ?? 1, 1, 10);
  const u = clamp(urge ?? 10, 1, 10);
  const urgeRev = 11 - u; // 10..1
  const avg = (c + urgeRev) / 2; // 1..10
  return Math.round(((avg - 1) / 9) * 20);
}
function scoreComplexity(vars, loops, clarity, originality, depth){
  // vars 0..20 -> 0..10
  // loops 0..10 -> 0..5
  // rubric (1..5 each) -> 0..5
  const v = clamp(vars ?? 0, 0, 20);
  const l = clamp(loops ?? 0, 0, 10);
  const vScore = (v / 20) * 10;
  const lScore = (l / 10) * 5;
  const rScore = (clamp(clarity ?? 1,1,5) + clamp(originality ?? 1,1,5) + clamp(depth ?? 1,1,5) - 3) / 12 * 5;
  return Math.round(clamp(vScore + lScore + rScore, 0, 20));
}
function scorePerspective(symmetry, nuance, unique){
  return scoreRubric5(symmetry, nuance, unique);
}

/* ---- Somatic scoring ---- */
function scoreCoordination(reps){
  const r = clamp(reps ?? 0, 0, 200);
  if(r <= 10) return 5;
  if(r <= 20) return 10;
  if(r <= 30) return 15;
  return 20;
}
function scoreBalance(seconds){
  const s = clamp(seconds ?? 0, 0, 300);
  if(s <= 5) return 5;
  if(s <= 15) return 10;
  if(s <= 25) return 15;
  return 20;
}
function scoreRecovery(seconds){
  const s = clamp(seconds ?? 999, 0, 999);
  if(s > 90) return 5;
  if(s >= 60) return 10;
  if(s >= 30) return 15;
  return 20;
}
function scoreSomaticIndex(foldScore, reps, balanceSec, recoverySec){
  const range = clamp(foldScore ?? 0, 0, 20);
  const coordination = scoreCoordination(reps);
  const balance = scoreBalance(balanceSec);
  const recovery = scoreRecovery(recoverySec);

  const total80 = range + coordination + balance + recovery; // 0..80
  const sei = Math.round((total80 / 80) * 100); // 0..100
  return { sei, range, coordination, balance, recovery, total80 };
}

function finishAndScore(){
  stopTimer();
  state.finishedAt = new Date().toISOString();

  // round 1 idea count
  const ideas = [
    ...splitIdeas(state.r1_water || ""),
    ...splitIdeas(state.r1_rock || ""),
    ...splitIdeas(state.r1_light || "")
  ];
  const ideaCount = ideas.length;
  const categoryCount = clamp(state.r1_categories ?? 0, 0, 20);

  const fluency = scoreRound1Fluency(ideaCount);
  const flexibility = scoreRound1Flex(categoryCount);

  const associative = scoreRubric5(state.r2_coherence, state.r2_originality, state.r2_depth);
  const perspective = scorePerspective(state.r3_symmetry, state.r3_nuance, state.r3_unique);
  const ambiguity = scoreAmbiguity(state.r4_comfort, state.r4_urge);
  const complexity = scoreComplexity(state.r5_vars, state.r5_loops, state.r5_clarity, state.r5_originality, state.r5_depth);

  // CEI
  const ambComplex = Math.round((ambiguity + complexity) / 2);
  const cei = fluency + flexibility + associative + perspective + ambComplex; // 0..100

  // Somatic
  const somatic = scoreSomaticIndex(state.s1_fold, state.s2_reps, state.s3_balance_sec, state.s4_recovery_sec);
  const ees = Math.round((cei + somatic.sei) / 2);
  const gap = Math.abs(cei - somatic.sei);

  // active time from timestamps
  const elapsedSec = Math.max(0, Math.round((Date.parse(state.finishedAt) - Date.parse(state.startedAt)) / 1000));

  const attempt = {
    id: cryptoRandomId(),
    meta: {
      attemptType: state.attemptType,
      displayName: state.displayName,
      startedAt: state.startedAt,
      finishedAt: state.finishedAt,
      activeSeconds: elapsedSec
    },
    inputs: { ...state },
    scores: {
      cei,
      fluency,
      flexibility,
      associative,
      perspective,
      ambiguity,
      complexity,
      ideaCount,
      categoryCount,
      sei: somatic.sei,
      ees,
      gap,
      somatic_range: somatic.range,
      somatic_coordination: somatic.coordination,
      somatic_balance: somatic.balance,
      somatic_recovery: somatic.recovery
    }
  };

  saveAttempt(attempt);
  showResults(attempt);
}

/* ---- Persistence ---- */
function loadAttempts(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return [];
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    return [];
  }
}
function saveAttempt(attempt){
  const attempts = loadAttempts();
  attempts.push(attempt);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(attempts));
}
function showStoredResults(){
  const attempts = loadAttempts();
  if(attempts.length === 0){
    alert("No attempts stored on this device yet.");
    return;
  }
  showResults(attempts[attempts.length - 1]);
}
function renderComparison(current){
  const attempts = loadAttempts();
  const baseline = [...attempts].reverse().find(a => a.meta.attemptType === "baseline");
  const post = [...attempts].reverse().find(a => a.meta.attemptType === "post");

  const el = document.getElementById("comparisonBlock");
  if(!baseline || !post){
    el.innerHTML = `
      <div class="notice">
        <strong>Comparison:</strong> Take both a Baseline and a Post attempt on this device to see before/after deltas.
      </div>
    `;
    return;
  }

  const delta = post.scores.cei - baseline.scores.cei;
  const klass = delta >= 8 ? "good" : (delta >= 2 ? "warn" : (delta >= 0 ? "warn" : "bad"));

  const rows = [
    ["CEI", baseline.scores.cei, post.scores.cei],
    ["SEI", baseline.scores.sei, post.scores.sei],
    ["EES", baseline.scores.ees, post.scores.ees],
    ["Gap", baseline.scores.gap, post.scores.gap],
    ["Fluency", baseline.scores.fluency, post.scores.fluency],
    ["Flexibility", baseline.scores.flexibility, post.scores.flexibility],
    ["Associative", baseline.scores.associative, post.scores.associative],
    ["Perspective", baseline.scores.perspective, post.scores.perspective],
    ["Ambiguity", baseline.scores.ambiguity, post.scores.ambiguity],
    ["Complexity", baseline.scores.complexity, post.scores.complexity],
    ["Ideas", baseline.scores.ideaCount, post.scores.ideaCount],
    ["Categories", baseline.scores.categoryCount, post.scores.categoryCount],
  ];

  const table = `
    <div class="card" style="background:#fff; border:1px solid var(--line); box-shadow:none;">
      <h3>Baseline vs Post (on this device)</h3>
      <p class="muted">Delta (CEI): <span class="${klass}">${delta >= 0 ? "+" : ""}${delta}</span></p>
      <div style="overflow:auto;">
        <table style="width:100%; border-collapse:collapse; font-size:14px;">
          <thead>
            <tr>
              <th style="text-align:left; padding:10px; border-bottom:1px solid var(--line);">Metric</th>
              <th style="text-align:right; padding:10px; border-bottom:1px solid var(--line);">Baseline</th>
              <th style="text-align:right; padding:10px; border-bottom:1px solid var(--line);">Post</th>
              <th style="text-align:right; padding:10px; border-bottom:1px solid var(--line);">Δ</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(([k,b,p]) => `
              <tr>
                <td style="padding:10px; border-bottom:1px solid var(--line);">${k}</td>
                <td style="padding:10px; text-align:right; border-bottom:1px solid var(--line);">${b ?? "—"}</td>
                <td style="padding:10px; text-align:right; border-bottom:1px solid var(--line);">${p ?? "—"}</td>
                <td style="padding:10px; text-align:right; border-bottom:1px solid var(--line);">${(p-b)>=0?"+":""}${(p-b) ?? "—"}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    </div>
  `;

  el.innerHTML = table;
}

/* ---- CSV Export ---- */
function exportCSV(){
  const attempts = loadAttempts();
  if(attempts.length === 0){
    alert("No attempts stored on this device yet.");
    return;
  }

  const headers = [
    "id","attemptType","displayName","startedAt","finishedAt","activeSeconds",
    "cei","sei","ees","gap",
    "fluency","flexibility","associative","perspective","ambiguity","complexity","ideaCount","categoryCount",
    "somatic_range","somatic_coordination","somatic_balance","somatic_recovery",
    "r1_categories","r1_unusual",
    "r2_coherence","r2_originality","r2_depth",
    "r3_symmetry","r3_nuance","r3_unique",
    "r4_comfort","r4_urge",
    "r5_vars","r5_loops","r5_clarity","r5_originality","r5_depth",
    "s1_fold","s2_reps","s3_balance_sec","s4_recovery_sec"
  ];

  const rows = attempts.map(a => {
    const m = a.meta, s = a.scores, i = a.inputs;
    const get = (k) => (i && i[k] !== undefined && i[k] !== null) ? String(i[k]).replaceAll('"','""') : "";
    return [
      a.id,
      m.attemptType,
      m.displayName || "",
      m.startedAt,
      m.finishedAt,
      m.activeSeconds,
      s.cei, s.sei, s.ees, s.gap,
      s.fluency, s.flexibility, s.associative, s.perspective, s.ambiguity, s.complexity, s.ideaCount, s.categoryCount,
      s.somatic_range, s.somatic_coordination, s.somatic_balance, s.somatic_recovery,
      get("r1_categories"),
      get("r1_unusual"),
      get("r2_coherence"), get("r2_originality"), get("r2_depth"),
      get("r3_symmetry"), get("r3_nuance"), get("r3_unique"),
      get("r4_comfort"), get("r4_urge"),
      get("r5_vars"), get("r5_loops"), get("r5_clarity"), get("r5_originality"), get("r5_depth"),
      get("s1_fold"), get("s2_reps"), get("s3_balance_sec"), get("s4_recovery_sec")
    ].map(v => `"${String(v ?? "").replaceAll('"','""')}"`).join(",");
  });

  const csv = headers.join(",") + "\n" + rows.join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `creative-expansion-lab_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ---- Utils ---- */
function cryptoRandomId(){
  if(window.crypto && crypto.getRandomValues){
    const buf = new Uint32Array(4);
    crypto.getRandomValues(buf);
    return [...buf].map(x => x.toString(16)).join("-");
  }
  return String(Math.random()).slice(2) + "-" + String(Date.now());
}

/* ---- Init ---- */
showIntro();
</script>
</body>
</html>
